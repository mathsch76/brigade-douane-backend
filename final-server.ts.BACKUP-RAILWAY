// final-server.ts - VERSION MODULAIRE 3.0
import 'dotenv/config'; // â† AJOUT POUR CHARGER LE .ENV
import express from 'express';
import { config } from './config-simple';

// Import des middleware
import { corsConfig } from './middlewares/cors';

// Import des routes modulaires
import authRoutes from './routes/auth';
import assistantRoutes from './routes/assistant';  // â† TON FICHIER EXISTANT
import systemRoutes from './routes/system';        // â† TON FICHIER EXISTANT

// Routes utilisateur (existantes)
import userPreferencesRoutes from './routes/user/preferences';

// LOGS DE DEMARRAGE
console.log('ğŸš€ NAO&CO Backend Starting - MODULAR VERSION...');
console.log('ğŸ“Š Environment:', config.nodeEnv);
console.log('ğŸŒ Port:', config.port);
console.log('ğŸ” Supabase:', config.supabaseUrl ? 'âœ… Connected' : 'âŒ Missing');
console.log('ğŸ¤– OpenAI:', config.openaiKey ? 'âœ… Configured' : 'âŒ Missing');
console.log('ğŸ”‘ JWT:', config.jwtSecret ? 'âœ… Configured' : 'âŒ Missing');

const app = express();

// MIDDLEWARE GLOBAL
app.use(corsConfig);
app.use(express.json({ limit: '1mb' }));

// ===============================================
// ROUTES MODULAIRES - NOUVELLE ARCHITECTURE
// ===============================================

// Routes d'authentification (ton systÃ¨me existant)
app.use('/auth', authRoutes);

// Routes utilisateur (tes routes existantes)
app.use('/user', userPreferencesRoutes);

// Routes assistants IA
app.use('/assistant', assistantRoutes);

// Routes systÃ¨me et monitoring
app.use('/api', systemRoutes);

// ===============================================
// ROUTES DE COMPATIBILITÃ‰ (pour Ã©viter la casse)
// ===============================================

// Route d'accueil
app.get('/', (req, res) => {
  res.json({ 
    message: 'NAO&CO Backend is running! ğŸš€',
    status: 'online',
    timestamp: new Date().toISOString(),
    version: '3.0-MODULAR',
    architecture: 'microservices',
    features: {
      auth: 'âœ… JWT + Refresh Tokens',
      database: 'âœ… Supabase',
      ai: 'âœ… OpenAI Assistants',
      cache: 'âœ… Intelligent Cache',
      preferences: 'âœ… User/Bot/Avatar'
    },
    routes: {
      auth: '/auth/*',
      user: '/user/*', 
      assistants: '/assistant/*',
      system: '/api/*'
    }
  });
});

// Route de compatibilitÃ© pour /user/me (si pas dans tes routes)
app.get('/user/me', async (req, res) => {
  // Rediriger vers tes routes existantes ou implÃ©menter ici
  res.status(501).json({ 
    error: 'Route to implement - use your existing auth routes' 
  });
});

// ===============================================
// GESTION D'ERREURS GLOBALE
// ===============================================

// 404 Handler
app.use('*', (req, res) => {
  res.status(404).json({
    error: 'Route not found',
    available_routes: [
      'GET / - Home',
      'POST /auth/login - Login',
      'GET /auth/verify - Token verification',
      'GET /user/preferences - User preferences',
      'POST /assistant/ask - Ask assistant',
      'GET /api/health - Health check'
    ],
    requested_path: req.originalUrl,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

// Error Handler Global
app.use((error: any, req: any, res: any, next: any) => {
  console.error('ğŸš¨ Global Error Handler:', error);
  
  res.status(error.status || 500).json({
    error: 'Internal Server Error',
    message: process.env.NODE_ENV === 'development' ? error.message : 'Something went wrong',
    timestamp: new Date().toISOString(),
    path: req.originalUrl
  });
});

// ===============================================
// DÃ‰MARRAGE SERVEUR
// ===============================================

const PORT = process.env.PORT || config.port || 4002;

app.listen(PORT, () => {
  console.log('='.repeat(50));
  console.log('ğŸš€ NAO&CO Server running on port', PORT);
  console.log('ğŸ“Š Environment:', config.nodeEnv);
  console.log('ğŸ—ï¸ Architecture: MODULAR (12 files)');
  console.log('âœ¨ Features: Complete system with intelligent cache');
  console.log('ğŸ¤– Assistants configured:', Object.values({
    emebi: process.env.ASSISTANT_EMEBI,
    macf: process.env.ASSISTANT_MACF,
    eudr: process.env.ASSISTANT_EUDR,
    sanctions: process.env.ASSISTANT_SANCTIONS
  }).filter(Boolean).length, '/4');
  console.log('ğŸŒ CORS origin:', process.env.FRONTEND_URL || 'default');
  console.log('='.repeat(50));
  console.log('ğŸ¯ Server ready for production!');
  
  // Test de connectivitÃ© au dÃ©marrage
  if (config.supabaseUrl && config.openaiKey) {
    console.log('âœ… All services connected and ready');
  } else {
    console.warn('âš ï¸ Some services may not be configured properly');
  }
});

export default app;